<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<link rel="lazy-import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="lazy-import" href="zr-dashboard.html">
<link rel="lazy-import" href="zr-profile.html">
<link rel="lazy-import" href="zr-catalog.html">
<link rel="lazy-import" href="zr-page-404.html">

<dom-module id="zr-app">
  <template>
    <style>
      :host {
        display: block;
      }

      app-header-layout {
        position: relative;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/:page"
      tail="{{subroute}}"></app-route>

    <app-drawer-layout fullbleed>
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer">
        <app-toolbar>Menu</app-toolbar>
        <iron-selector selected="[[_page]]" attr-for-selected="name" class="drawer-list" role="navigation">
          <a name="home" href="dashboard">Home</a>
          <a name="profile" href="account">Profile</a>
        </iron-selector>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout>

        <iron-pages selected="[[_page]]" attr-for-selected="name" fallback-selection="page-404">

          <zr-dashboard
            name="dashboard"
            app-name="[[appName]]"
            user-id="[[user.id]]"
            small-screen="[[smallScreen]]"
            medium-screen="[[mediumScreen]]"></zr-dashboard>

          <zr-catalog
            name="catalog"
            default-action="list"
            user-id="[[user.id]]"
            route="[[subroute]]"
            small-screen="[[smallScreen]]"
            medium-screen="[[mediumScreen]]"></zr-catalog>

          <zr-profile
            name="profile"
            user-id="[[user.id]]"
            small-screen="[[smallScreen]]"
            medium-screen="[[mediumScreen]]"></zr-profile>

          <zr-page-404 name="page-404"></zr-page-404>

        </iron-pages>

      </app-header-layout>
    </app-drawer-layout>

  </template>

  <script>
    class ZRApp extends Polymer.Element {

      static get is() { return 'zr-app'; }

      static get properties() {
        return {

          defaultPage: String,

          appName: String,

          user: Object,

          _page: {
            type: String,
            observer: '_pageChanged'
          },

          route: {
            type: Object,
            observer: '_routeChanged'
          },

          subroute: Object,

          smallScreen: Boolean,

          mediumScreen: Boolean

        };
      }

      _checkActiveRoute(route) {
        //https://stackoverflow.com/questions/2647867/how-to-determine-if-variable-is-undefined-or-null
        if (route.path == null) { return false; }
        return true;
      }

      _routeChanged(route) {
        if (!this._checkActiveRoute(route)) { return; }

        const path = route.path.split('/');
        var page = path[1];
        const restPath = path[2] ? path[2].split('/') : null;

        // redirect removing rest path.
        if (restPath && page !== 'catalog') {
          ZRCommon.updateWindowLocation('/' + page);
          return;
        }
        
        if (page == 'account') {
          page = 'profile';
        }

        // redirect to defaultPage if there is no page.
        if (!page || page === '') {
          ZRCommon.updateWindowLocation('/' + this.defaultPage);
          return;
        }

        // update page.
        this._page = page;
      }

      _pageChanged(_page) {
        // Load page import on demand
        const resolvedPageUrl = this.resolveUrl('zr-' + _page + '.html');
        Polymer.importHref(resolvedPageUrl, null, null, true);
      }

    }

    window.customElements.define(ZRApp.is, ZRApp);

  </script>
</dom-module>

